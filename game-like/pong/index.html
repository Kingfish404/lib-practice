<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game</title>
    <style>
        * {
            touch-action: pan-y;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }

        #root {
            display: flex;
            flex: 1 1 auto;
            color: white;
            background-color: black;
        }

        #menu {
            position: fixed;
            text-align: center;
            width: 100%;
            user-select: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #play_ground {
            display: flex;
            flex: 1 1 auto;
            justify-content: space-between;
        }

        #player_a,
        #player_b {
            height: 100px;
            width: 10px;
            position: relative;
            background-color: white;
            transition: 0.01s linear;
            transition-property: top;
            will-change: top;
        }

        #ball {
            width: 10px;
            height: 10px;
            position: fixed;
            border-radius: 10px;
            background-color: white;
            transition-property: top, left;
            will-change: top, left;
        }

        #middle_line {
            border: 1px solid white;
            border-style: dashed;
        }
    </style>
</head>

<body>
    <div id="root">
        <div id="menu">
            <button id="menu_btn_stop"></button>
            <h1 id="menu_title"></h1>
        </div>
        <div id="play_ground">
            <div id="player_a"></div>
            <div id="ball"></div>
            <div id="middle_line"></div>
            <div id="player_b"></div>
        </div>
    </div>
    <p>Pong Game wirte by <a href="https://kingfish404.cn" target="_blank">Kingfish404</a></p>
    <script>
        var global = {
            width: document.getElementById('play_ground').clientWidth,
            height: document.getElementById('play_ground').clientHeight,
            half_width: document.getElementById('play_ground').clientWidth / 2,
            half_height: document.getElementById('play_ground').clientHeight / 2,
            game: {
                main: null,
                is_start: false
            },
            player_a: {
                node: document.getElementById('player_a'),
                height: document.getElementById('player_a').clientHeight,
                data: {
                    y: 0,
                    speed: 5,
                }
            },
            player_b: {
                node: document.getElementById('player_b'),
                height: document.getElementById('player_b').clientHeight,
                data: {
                    y: 0,
                    speed: 20,
                }
            },
            ball: {
                node: document.getElementById('ball'),
                height: document.getElementById('ball').clientHeight,
                data: {
                    x: 0,
                    y: 0,
                    speed: 10,
                    angle: 60,
                }
            },
        }

        function handleMove(clientX, clientY) {
            if (clientX < global.half_width) {
                global.player_a.data.y = clientY;
                var transform_str = "translateY(" + String(global.player_a.data.y - global.player_a.height / 2) + "px)";
                global.player_a.node.style.transform = transform_str;
            }
        }

        function adapterMouse(e) {
            e.preventDefault();
            handleMove(e.clientX, e.clientY);
        }

        function adapterTouch(e) {
            e.preventDefault();
            handleMove(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            return;
        }

        function gameMain() {
            var radian = global.ball.data.angle * Math.PI / 180;
            var isHit = false;

            // ball move
            global.ball.data.x += Math.sin(radian) * global.ball.data.speed;
            global.ball.data.y += Math.cos(radian) * global.ball.data.speed;

            // ball chack
            if (global.ball.data.y < 0 || global.ball.data.y > global.height) {
                // hit up or down
                global.ball.data.angle = 180 - global.ball.data.angle;
                isHit = true;
            } else if (global.ball.data.x < 0) {
                // console.log(global.ball.data.y, global.player_a.data.y, global.player_a.height / 2, global.ball.height)
                setTimeout(() => {
                    if (global.ball.data.y > (global.player_a.data.y + global.player_a.height / 2 + global.ball.height) ||
                        global.ball.data.y < (global.player_a.data.y - global.player_a.height / 2 - global.ball.height)) {
                        gameOver();
                    }
                }, 25);
                var between = global.ball.data.y - global.player_a.data.y;
                between = Math.min(between, 20);
                between = Math.max(between, -20);
                global.ball.data.angle = 360 - global.ball.data.angle - between + Math.random() * 10 - 5;
                global.ball.data.speed *= 1.1;
                isHit = true;
            } else if (global.ball.data.x > global.width) {
                if (global.ball.data.y > (global.player_b.data.y + global.player_b.height / 2 + global.ball.height) ||
                    global.ball.data.y < (global.player_b.data.y - global.player_b.height / 2 - global.ball.height)) {
                    gameWin();
                    return;
                }
                global.ball.data.angle = 360 - global.ball.data.angle;
                isHit = true;
            }
            if (isHit) {
                return;
            }

            // player b move
            if (Math.abs(global.ball.data.y - global.player_b.data.y) > global.player_b.height / 3) {
                global.player_b.data.y += Math.min(global.player_b.data.speed * (global.ball.data.y - global.player_b.data.y > 0 ? 1 : -1));
            } else if (global.ball.data.y > global.half_width && (global.ball.data.angle > 60 || global.ball.data.angle < 120)) {
                global.player_b.data.y += Math.min(global.player_b.data.speed * (global.ball.data.y - global.player_b.data.y > 0 ? 1 : -1), 5) * Math.cos(radian);
            }

            // ball show generate
            global.ball.node.style.top = global.ball.data.y + 'px';
            global.ball.node.style.left = global.ball.data.x + 'px';

            // player b genreate
            var transform_str = "translateY(" + String(global.player_b.data.y - global.player_b.height / 2) + "px)";
            global.player_b.node.style.transform = transform_str;
        }

        function addLisitener() {
            window.onmousemove = adapterMouse;
            window.addEventListener(
                'touchstart',
                adapterTouch,
                { passive: false }
            );
            window.addEventListener(
                'touchmove',
                adapterTouch,
                { passive: false }
            );
            window.addEventListener(
                'touchend',
                adapterTouch,
                { passive: false }
            );
        }
        function removeLisitener() {
            window.removeEventListener('mousemove', window);
            window.removeEventListener('touchstart', window);
            window.removeEventListener('touchmove', window);
            window.removeEventListener('touchend', window);
        }

        function gameStart() {
            removeLisitener();
            clearInterval(global.game.main);
            global.game.main = setInterval(gameMain, 20);
            document.getElementById('menu_btn_stop').innerText = "STOP";
            document.getElementById('menu_title').innerText = '';
            document.getElementById('menu_btn_stop').onclick = gameStop;
            addLisitener();
        }
        function gameStop() {
            clearInterval(global.game.main);
            global.game.main = null;
            removeLisitener();
            document.getElementById('menu_btn_stop').onclick = gameStart;
            document.getElementById('menu_btn_stop').innerText = "START";
        }
        function gameOver() {
            gameStop();
            window.addEventListener('touchstart', () => {
                if (global.game.main != null) {
                    return;
                };
                global.ball.data.speed = 10;
                global.ball.data.angle = Math.random() * 90 + 30;
                global.ball.data.x = 0;
                global.ball.data.y = global.player_a.data.y;
                gameStart();
            });
            document.getElementById('menu_title').innerText = "GAME OVER";
        }
        function gameWin() {
            gameStop();
            window.addEventListener('touchstart', () => {
                if (global.game.main != null) {
                    return;
                }
                global.ball.data.speed = 10;
                global.ball.data.angle = Math.random() * 90 + 30;
                global.ball.data.x = 0;
                global.ball.data.y = global.player_a.data.y;
                gameStart();
            });
            document.getElementById('menu_title').innerText = "YOU WIN";
        }

        function initGame() {
            document.getElementById('menu_btn_stop').onclick = gameStart;
            document.getElementById('menu_btn_stop').innerText = "START";
            global.ball.data.speed = 10;
            global.ball.data.angle = Math.random() * 90 + 30;
            global.ball.data.y = global.player_a.data.y;
        }
        initGame();
    </script>
</body>

</html>